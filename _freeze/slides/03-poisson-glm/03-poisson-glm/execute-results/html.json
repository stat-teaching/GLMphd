{
  "hash": "e73c20f72e1684e1fb16cd832253feb5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Poisson GLM\nbibliography: \"https://raw.githubusercontent.com/filippogambarota/bib-database/main/references.bib\"\ncsl: \"https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl\"\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n\n\n\n\n\n## Poisson GLM\n\nEverything that we discussed for the binomial GLM is also relevant for the Poisson GLM. We are gonna focus on specificity of the Poisson model in particular:\n\n- **Poisson distribution** and **link function**\n- **Parameters interpretation**\n- **Overdispersion** causes, consequences and remedies\n\n# Poisson distribution {.section}\n\n## Poisson distribution\n\nThe Poisson distribution is defined as:\n\n$$\np(y; \\lambda) = \\frac{\\lambda^y e^{-\\lambda}}{y!}\n$$\nWhere the mean is $\\lambda$ and the variance is $\\lambda$\n\n## Poisson distribution\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-4-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Poisson distribution\n\nAs the mean increases also the variance increase and the distributions is approximately normal:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-5-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Poisson distribution\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-6-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Link function\n\nThe common (and default in R) link function ($g(\\lambda)$) for the Poisson distribution is the **log** link function and the inverse of link function is the exponential.\n\n\\begin{align*}\nlog(\\lambda_i) = \\beta_0 + \\beta_1x_{i1} + \\beta_2x_{i2} + \\cdots + \\beta_px_{ip} \\\\\n\\lambda_i = e^{\\beta_0 + \\beta_1x_{i1} + \\beta_2x_{i2} + \\cdots + \\beta_px_{ip}}\n\\end{align*}\n\n# Parameters intepretation {.section}\n\n## An example...\n\nLet's start by a simple example trying to explain the number of errors of math exercises by students (N = 100) as a function of the number of hours of study.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"yqnimxfoot\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#yqnimxfoot table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#yqnimxfoot thead, #yqnimxfoot tbody, #yqnimxfoot tfoot, #yqnimxfoot tr, #yqnimxfoot td, #yqnimxfoot th {\n  border-style: none;\n}\n\n#yqnimxfoot p {\n  margin: 0;\n  padding: 0;\n}\n\n#yqnimxfoot .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#yqnimxfoot .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#yqnimxfoot .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#yqnimxfoot .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#yqnimxfoot .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#yqnimxfoot .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#yqnimxfoot .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#yqnimxfoot .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#yqnimxfoot .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#yqnimxfoot .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#yqnimxfoot .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#yqnimxfoot .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#yqnimxfoot .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#yqnimxfoot .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#yqnimxfoot .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yqnimxfoot .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#yqnimxfoot .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#yqnimxfoot .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#yqnimxfoot .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yqnimxfoot .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#yqnimxfoot .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yqnimxfoot .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#yqnimxfoot .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yqnimxfoot .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#yqnimxfoot .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yqnimxfoot .gt_left {\n  text-align: left;\n}\n\n#yqnimxfoot .gt_center {\n  text-align: center;\n}\n\n#yqnimxfoot .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#yqnimxfoot .gt_font_normal {\n  font-weight: normal;\n}\n\n#yqnimxfoot .gt_font_bold {\n  font-weight: bold;\n}\n\n#yqnimxfoot .gt_font_italic {\n  font-style: italic;\n}\n\n#yqnimxfoot .gt_super {\n  font-size: 65%;\n}\n\n#yqnimxfoot .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#yqnimxfoot .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#yqnimxfoot .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#yqnimxfoot .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#yqnimxfoot .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#yqnimxfoot .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#yqnimxfoot .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"id\">id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"studyh\">studyh</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"solved\">solved</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">1</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">14</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">15</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">2</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">11</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">13</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">3</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">91</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">60</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">4</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">55</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">36</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">...</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">...</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">...</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">97</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">49</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">30</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">98</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">3</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">6</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">99</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">52</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">28</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">100</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">90</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">68</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n## An example...\n\n- There is a clear non-linear and positive relationship\n- The both the mean and variance increase as a function of the predictor\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-8-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Model fitting\n\nWe can fit the model using the `glm` function in R setting the appropriate **random component** (`family`) and the **link function** (`link`):\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit <- glm(solved ~ studyh, family = poisson(link = \"log\"), data = dat)\n\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = solved ~ studyh, family = poisson(link = \"log\"), \n#>     data = dat)\n#> \n#> Coefficients:\n#>             Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)  2.29825    0.04603   49.92   <2e-16 ***\n#> studyh       0.02066    0.00065   31.78   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for poisson family taken to be 1)\n#> \n#>     Null deviance: 1226.469  on 99  degrees of freedom\n#> Residual deviance:   95.636  on 98  degrees of freedom\n#> AIC: 610.72\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\n\n## Parameters intepretation\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n\n- The `(Intercept)` $2.298$ is the log of the expected number of solved exercises for a student with 0 hours of studying. Taking the exponential we obtain the estimation on the response scale $9.957$\n- the `studyh` $0.021$ is the increase in the expected increase of (log) solved exercises for a unit increase in hours of studying. Taking the exponential we obtain the ratio of increase of the number of solved exercises $1.021$\n\n## Parameters intepretation\n\nAgain, as in the binomial model, the effects are linear on the log scale but non-linear on the response scale.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-11-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Parameters intepretation\n\nThe non-linearity can be easily seen using the `predict()` function:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlinear <- predict(fit, newdata = data.frame(studyh = c(10, 11)))\ndiff(linear) # same as the beta0\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>          2 \n#> 0.02065628\n```\n\n\n:::\n\n```{.r .cell-code}\nnonlinear <- exp(linear) # or predict(..., type = \"response\")\ndiff(nonlinear)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>         2 \n#> 0.2554891\n```\n\n\n:::\n\n```{.r .cell-code}\n# ratio of increase when using the response scale\nnonlinear[2]/nonlinear[1]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>        2 \n#> 1.020871\n```\n\n\n:::\n\n```{.r .cell-code}\n# equivalent to exp(beta1)\nexp(coef(fit)[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>   studyh \n#> 1.020871\n```\n\n\n:::\n:::\n\n\n\n## Parameters intepretation - Categorical variable\n\nLet's make a similar example with the number of solved exercises comparing students who attended online classes and students attending in person. The `class_c` is the dummy version of `class` (0 = online, 1 = inperson).\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"ccefcspdhb\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#ccefcspdhb table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#ccefcspdhb thead, #ccefcspdhb tbody, #ccefcspdhb tfoot, #ccefcspdhb tr, #ccefcspdhb td, #ccefcspdhb th {\n  border-style: none;\n}\n\n#ccefcspdhb p {\n  margin: 0;\n  padding: 0;\n}\n\n#ccefcspdhb .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#ccefcspdhb .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ccefcspdhb .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ccefcspdhb .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ccefcspdhb .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ccefcspdhb .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ccefcspdhb .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ccefcspdhb .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ccefcspdhb .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#ccefcspdhb .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#ccefcspdhb .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ccefcspdhb .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ccefcspdhb .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ccefcspdhb .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ccefcspdhb .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ccefcspdhb .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#ccefcspdhb .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#ccefcspdhb .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#ccefcspdhb .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ccefcspdhb .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#ccefcspdhb .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ccefcspdhb .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ccefcspdhb .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ccefcspdhb .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ccefcspdhb .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ccefcspdhb .gt_left {\n  text-align: left;\n}\n\n#ccefcspdhb .gt_center {\n  text-align: center;\n}\n\n#ccefcspdhb .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ccefcspdhb .gt_font_normal {\n  font-weight: normal;\n}\n\n#ccefcspdhb .gt_font_bold {\n  font-weight: bold;\n}\n\n#ccefcspdhb .gt_font_italic {\n  font-style: italic;\n}\n\n#ccefcspdhb .gt_super {\n  font-size: 65%;\n}\n\n#ccefcspdhb .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#ccefcspdhb .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#ccefcspdhb .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#ccefcspdhb .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#ccefcspdhb .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#ccefcspdhb .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#ccefcspdhb .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"id\">id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"class\">class</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"class_c\">class_c</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"solved\">solved</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">1</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">8</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">2</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">12</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">3</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">10</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">4</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">10</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">...</td>\n<td headers=\"class\" class=\"gt_row gt_center\">...</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">...</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">...</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">97</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">15</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">98</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">11</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">99</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">9</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">100</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">17</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n## Parameters intepretation - Categorical variable\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-14-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Parameters intepretation - Categorical variable\n\nR by default set the categorical variables using **dummy-coding**. In this case we set the reference category to `online`.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit <- glm(solved ~ class, family = poisson(link = \"log\"), data = dat)\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = solved ~ class, family = poisson(link = \"log\"), \n#>     data = dat)\n#> \n#> Coefficients:\n#>               Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)    2.26592    0.04555  49.747  < 2e-16 ***\n#> classinperson  0.39574    0.05892   6.717 1.86e-11 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for poisson family taken to be 1)\n#> \n#>     Null deviance: 140.610  on 99  degrees of freedom\n#> Residual deviance:  94.609  on 98  degrees of freedom\n#> AIC: 525.84\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n\n## Parameters intepretation - Categorical variable\n\n- Similarly to the previous example, the intercept is the expected number of solved exercises when the `class` is 0. Thus the expected number of solved exercises for online students.\n- the `classinperson` is the difference in log solved exercises between online and in person classes. In the response scale is the expected increase in the ratio of solved exercises. People doing in person classes solve 148.55% of the exercises of people doing online classes\n\n. . .\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nc(coef(fit)[\"(Intercept)\"], exp(coef(fit)[\"(Intercept)\"]))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> (Intercept) (Intercept) \n#>    2.265921    9.640000\n```\n\n\n:::\n\n```{.r .cell-code}\nc(coef(fit)[\"classinperson\"], exp(coef(fit)[\"classinperson\"]))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> classinperson classinperson \n#>     0.3957361     1.4854772\n```\n\n\n:::\n:::\n\n\n\n# Overdispersion {.section}\n\n## Overdispersion\n\n**Overdispersion** concerns observing a greater variance compared to what would have been expected by the model.\n\nThe **overdispersion** $\\phi$ can be estimated using Pearson Residuals:\n\n\\begin{align*}\n\\hat \\phi = \\frac{\\sum_{i = 1}^n \\frac{(y_i - \\hat y_i)^2}{\\hat y_i}}{n - p - 1}\n\\end{align*}\n\n\nWhere the numerator is the sum of squared Pearson residuals, $n$ is the number of observations and $k$ the number of predictors. For standard Binomial and Poisson models $\\phi = 1$.\n\n<!-- ref(\"Applied Regression Analysis and Generalized Linear Models, Fox (2016)\", chapter = \"15\", page = \"432\") -->\n\n## Overdispersion\n\nIf the model is correctly specified for binomial and poisson models the ratio is equal to 1, of the ratio is $> 1$ there is evidence for overdispersion. In practical terms, if the residual deviance is higher than the residuals degrees of freedom, there is evidence for overdispersion.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nP <- sum(residuals(fit, type = \"pearson\")^2)\nP / df.residual(fit) # nrow(fit$dat) - length(fit_p$coefficients)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.9465021\n```\n\n\n:::\n:::\n\n\n\n## Testing overdispersion\n\nTo formally test for overdispersion i.e. testing if the ratio is significantly different from 1 we can use the `performance::check_overdispersion()` function.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nperformance::check_overdispersion(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # Overdispersion test\n#> \n#>        dispersion ratio =  0.947\n#>   Pearson's Chi-Squared = 92.757\n#>                 p-value =  0.631\n```\n\n\n:::\n:::\n\n\n\n<!-- ref(\"Regression and Multilevel Models, (Gelman and Hill, 2007)\", 6, \"114-115\") -->\n\n## Overdispersion plot\n\nPearson residuals are defined as:\n\n\\begin{align*}\nr_p = \\frac{y_i - \\hat y_i}{\\sqrt{V(\\hat y_i)}} \\\\\nV(\\hat y_i) = \\sqrt{\\hat y_i}\n\\end{align*}\n\nRemember that the mean and the variance are the same in Poisson models. If the model is correct, the standardized residuals should be normally distributed with mean 0 and variance 1.\n\n## Overdispersion plot\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-20-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n<!-- ref(\"Regression and Multilevel Models, (Gelman \\\\& Hill, 2007)\", 6, 114) -->\n\n## Variance-mean relationship\n\nThe overdispersion can be expressed also in terms of variance-mean ratio. In fact, when the ratio is 1, there is no evidence of overdispersion.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-21-1.svg){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Causes of overdispersion\n\nThere could be multiple causes for overdispersion:\n\n- the **phenomenon itself** cannot be modelled with a Poisson distribution\n- **outliers or anomalous obervations** that increases the observed variance\n- **missing important variables** in the model\n\n## Outliers or anomalous data\n\nThis (simulated) dataset contains $n = 30$ observations coming from a poisson model in the form $y = 1 + 2x$ and $n = 7$ observations coming from a model $y = 1 + 10x$.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-22-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Outliers or anomalous data\n\nClearly the sum of squared pearson residuals is inflated by these values producing more variance compared to what should be expected.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nc(mean = mean(datout$y), var = var(datout$y)) # mean and variance should be similar\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>     mean      var \n#> 2.756757 6.689189\n```\n\n\n:::\n\n```{.r .cell-code}\nperformance::check_overdispersion(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # Overdispersion test\n#> \n#>        dispersion ratio =  1.515\n#>   Pearson's Chi-Squared = 53.019\n#>                 p-value =  0.026\n```\n\n\n:::\n:::\n\n\n\n## Missing important variables in the model\n\nLet's imagine to analyze again the dataset with the number of solved exercises. We have the effect of the `studyh` variable. In addition we have the effect of the `class` variable, without interaction.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"hpqpruoaru\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#hpqpruoaru table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#hpqpruoaru thead, #hpqpruoaru tbody, #hpqpruoaru tfoot, #hpqpruoaru tr, #hpqpruoaru td, #hpqpruoaru th {\n  border-style: none;\n}\n\n#hpqpruoaru p {\n  margin: 0;\n  padding: 0;\n}\n\n#hpqpruoaru .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#hpqpruoaru .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#hpqpruoaru .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#hpqpruoaru .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#hpqpruoaru .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#hpqpruoaru .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#hpqpruoaru .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#hpqpruoaru .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#hpqpruoaru .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#hpqpruoaru .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#hpqpruoaru .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#hpqpruoaru .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#hpqpruoaru .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#hpqpruoaru .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#hpqpruoaru .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#hpqpruoaru .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#hpqpruoaru .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#hpqpruoaru .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#hpqpruoaru .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#hpqpruoaru .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#hpqpruoaru .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#hpqpruoaru .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#hpqpruoaru .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#hpqpruoaru .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#hpqpruoaru .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#hpqpruoaru .gt_left {\n  text-align: left;\n}\n\n#hpqpruoaru .gt_center {\n  text-align: center;\n}\n\n#hpqpruoaru .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#hpqpruoaru .gt_font_normal {\n  font-weight: normal;\n}\n\n#hpqpruoaru .gt_font_bold {\n  font-weight: bold;\n}\n\n#hpqpruoaru .gt_font_italic {\n  font-style: italic;\n}\n\n#hpqpruoaru .gt_super {\n  font-size: 65%;\n}\n\n#hpqpruoaru .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#hpqpruoaru .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#hpqpruoaru .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#hpqpruoaru .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#hpqpruoaru .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#hpqpruoaru .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#hpqpruoaru .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"id\">id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"class\">class</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"studyh\">studyh</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"class_c\">class_c</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"lp\">lp</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"solved\">solved</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">1</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">82</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">22.613</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">24</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">2</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">65</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">47.734</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">50</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">3</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">12</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">11.268</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">15</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">4</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">54</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">42.785</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">50</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">...</td>\n<td headers=\"class\" class=\"gt_row gt_center\">...</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">...</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">...</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">...</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">...</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">37</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">85</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">23.298</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">35</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">38</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">55</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">43.213</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">43</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">39</td>\n<td headers=\"class\" class=\"gt_row gt_center\">online</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">80</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">0</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">22.167</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">26</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">40</td>\n<td headers=\"class\" class=\"gt_row gt_center\">inperson</td>\n<td headers=\"studyh\" class=\"gt_row gt_center\">77</td>\n<td headers=\"class_c\" class=\"gt_row gt_center\">1</td>\n<td headers=\"lp\" class=\"gt_row gt_center\">53.788</td>\n<td headers=\"solved\" class=\"gt_row gt_center\">54</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n## Missing important variables in the model\n\nWe can also have a look at the data:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-25-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Missing important variables in the model\n\nNow let's fit the model considering only `studyh` and ignoring the group:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit <- glm(solved ~ studyh, data = dat, family = poisson(link = \"log\"))\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = solved ~ studyh, family = poisson(link = \"log\"), \n#>     data = dat)\n#> \n#> Coefficients:\n#>             Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) 2.692791   0.068831   39.12   <2e-16 ***\n#> studyh      0.013624   0.001063   12.82   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for poisson family taken to be 1)\n#> \n#>     Null deviance: 417.99  on 39  degrees of freedom\n#> Residual deviance: 243.99  on 38  degrees of freedom\n#> AIC: 451.39\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\n\n## Missing important variables in the model\n\nEssentially, we are fitting an average relationship across groups but the model ignore that the two groups differs, thus the observed variance is definitely higher because we need two separate means to explain the `class` effect.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-27-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Missing important variables in the model\n\nBy fitting the appropriate model, the overdispersion is no longer a problem:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit2 <- glm(solved ~ studyh + class, data = dat, family = poisson(link = \"log\"))\nsummary(fit2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = solved ~ studyh + class, family = poisson(link = \"log\"), \n#>     data = dat)\n#> \n#> Coefficients:\n#>               Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)   2.275159   0.078239   29.08   <2e-16 ***\n#> studyh        0.010895   0.001068   10.21   <2e-16 ***\n#> classinperson 0.907365   0.065373   13.88   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for poisson family taken to be 1)\n#> \n#>     Null deviance: 417.993  on 39  degrees of freedom\n#> Residual deviance:  29.022  on 37  degrees of freedom\n#> AIC: 238.41\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\n\n## Missing important variables in the model\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nperformance::check_overdispersion(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # Overdispersion test\n#> \n#>        dispersion ratio =   6.115\n#>   Pearson's Chi-Squared = 232.369\n#>                 p-value = < 0.001\n```\n\n\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nperformance::check_overdispersion(fit2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # Overdispersion test\n#> \n#>        dispersion ratio =  0.777\n#>   Pearson's Chi-Squared = 28.738\n#>                 p-value =  0.832\n```\n\n\n:::\n:::\n\n\n\n## Missing important variables in the model\n\nAlso the residuals plots clearly improved after including all relevant predictors:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-31-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Why worring about overdispersion?\n\nBefore analyzing the two main strategies to deal with overdispersion, it is important to understand why it is very problematic.\n\n- Despite the estimated parameters ($\\beta$) are not affected by overdispersion, standard errors are underestimated. The underestimation increases as the severity of the overdispersion increases.\n- Underestimated standard errors produces (biased) higher $z$ scores inflating the type-1 error (i.e., lower p values)\n\n## Why worring about overdispersion?\n\nThe estimated overdispersion of `fit` is ~ 6.4208936. The `summary()` function in R has a `dispersion` argument to check how model parameters are affected.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nphi <- fit$deviance / fit$df.residual\nsummary(fit, dispersion = 1)$coefficients # the default\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>               Estimate  Std. Error  z value     Pr(>|z|)\n#> (Intercept) 2.69279058 0.068830558 39.12202 0.000000e+00\n#> studyh      0.01362422 0.001062724 12.82009 1.265575e-37\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fit, dispersion = 2)$coefficients # assuming phi = 2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>               Estimate  Std. Error   z value      Pr(>|z|)\n#> (Intercept) 2.69279058 0.097341109 27.663447 1.923115e-168\n#> studyh      0.01362422 0.001502919  9.065171  1.244091e-19\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fit, dispersion = phi)$coefficients # the appropriate\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>               Estimate  Std. Error   z value     Pr(>|z|)\n#> (Intercept) 2.69279058 0.174413070 15.439156 8.926080e-54\n#> studyh      0.01362422 0.002692888  5.059333 4.207258e-07\n```\n\n\n:::\n:::\n\n\n\n## Why worring about overdispersion?\n\nBy using multiple values for $\\phi$ we can see the impact on the standard error. $\\phi = 1$ is what is assumed by the Poisson model.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-33-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n# Dealing with overdispersion {.section}\n\n## Dealing with overdispersion\n\nIf all the variables are included and there are no outliers, the phenomenon itself contains more variability compared to what predicted by the Poisson. There are two main approaches to deal with the situation:\n\n- **quasi-poisson** model\n- poisson-gamma model AKA **negative-binomial model**\n- **multilevel poisson** model\n\n## Quasi-poisson model\n\nThe **quasi-poisson** model is essentially a poisson model that estimate the $\\phi$ parameter and adjust the standard errors accordingly. Again, assuming to fit the `studyh` only model (with overdispersion):\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit <- glm(solved ~ studyh, data = dat, family = quasipoisson(link = \"log\"))\nsummary(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = solved ~ studyh, family = quasipoisson(link = \"log\"), \n#>     data = dat)\n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 2.692791   0.170209  15.821  < 2e-16 ***\n#> studyh      0.013624   0.002628   5.184 7.46e-06 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for quasipoisson family taken to be 6.115055)\n#> \n#>     Null deviance: 417.99  on 39  degrees of freedom\n#> Residual deviance: 243.99  on 38  degrees of freedom\n#> AIC: NA\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\n\n## Quasi-poisson model\n\nThe quasi-poisson model estimates the same parameters ($\\beta$) and adjust standard errors. Notice that using `summary(dispersion = )` is the same as fitting a quasi-Poisson model and using the estimated $\\phi$.\n\nThe quasi-poisson model is useful because it is a very simple way to deal with overdispersion.\n\nThe variance ($V(\\mu)$) of the Poisson model is no longer $\\mu$ but $V(\\mu) = \\mu\\phi$. When $\\phi$ is close to 1, the quasi-Poisson model reduced to a standard Poisson model\n\n## Quasi-poisson model\n\nHere we compare the expected variance ($\\pm 2\\sqrt{V(y_i)}$)^[This is just an example that did not take into account the link function (notice that the yellow line goes a little bit under 0)] of the Quasi-Poisson and Poisson models:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-35-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Problems of Quasi-* model\n\nThe main problem of quasi-* models is that they are not a specific distribution family and there is not a likelihood function. For this reason, we cannot perform model comparison the standard AIC/BIC. See [@Ver_Hoef2007-jc] for an overview.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nAIC(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] NA\n```\n\n\n:::\n\n```{.r .cell-code}\nBIC(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] NA\n```\n\n\n:::\n:::\n\n\n\n## Negative-binomial model\n\nA negative binomial model is different probability distribution with two parameters: the mean as in standard poisson model and the dispersion parameter. Similarly to the quasi-poisson model it estimates a dispersion parameter.\n\nPractically the negative-binomial model can be considered as a hierarchical model:\n\n\\begin{align*}\ny_i \\sim Poisson(\\lambda_i) \\\\\n\\lambda_i \\sim Gamma(\\mu, \\frac{1}{\\theta})\n\\end{align*}\n\nIn this way, the Gamma distribution regulate the $\\lambda$ variability that otherwise is fixed to a single value in the Poisson model.\n\n<!-- ref(\"Generalized linear models, Dunn (2018)\", \"10\", \"400\") -->\n\n## Negative-binomial model^[There are multiple parametrizations of the negative-binomial distribution. The one used by `MASS` is in terms of poisson-gamma mixture see https://mc-stan.org/docs/2_20/functions-reference/nbalt.html]\n\nThe Poisson-Gamma mixture can be expressed as:\n\n$$\np(y; \\mu, \\theta) = \\frac{\\Gamma(y + \\theta)}{\\Gamma(\\theta)\\Gamma(y + 1)}\\left(\\frac{\\mu}{\\mu + \\theta}\\right)^{y} \\left(\\frac{\\theta}{\\mu + \\theta}\\right)^\\theta\n$$\n\nWhere $\\theta$ is the overdispersion parameter, $\\Gamma()$ is the gamma function. The mean is $\\mu$ and the variance is $\\mu + \\frac{\\mu^2}{\\theta}$. The $\\theta$ is the inverse of the overdispersion in terms that as $1/\\theta$ increase the data are more overdispersed. As $1/\\theta$ approaches 0, the negative-binomial reduced to a Poisson model.\n\n<!-- ref(\"Generalized linear models, Dunn (2018)\", \"10\", \"400\") -->\n\n## Negative-binomial model\n\nCompared to the Poisson model, the negative binomial allows for overdispersion estimating the parameter $\\theta$ and compared to the quasi-poisson model the variance is not a linear increase of the mean ($V(\\mu) = \\theta\\mu$) but have a quadratic relationship $V(\\mu) = \\mu + \\mu^2/\\theta$\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-37-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n\n## Negative-binomial model\n\nWe can use the `MASS` package to implement the negative binomial distribution using the `MASS::rnegbin()`:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-38-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Negative-binomial model\n\nThe $\\theta$ parameter is the estimated dispersion. To note, is not the same as $\\phi$ in the quasi-poisson model. As $\\theta$ increase, the overdispersion is reduced and the model is similar to a standard Poisson model.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-39-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Negative-binomial model\n\nFor fitting a negative-binomial model we cannot use the `glm` function but we need to use the `MASS::glm.nb()` function. The syntax is almost the same but we do not need to specify the family because this function only fit negative-binomial models. Let's simulate some data coming from a negative binomial distribution with $\\theta = 10$\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ntheta <- 10\nn <- 100\nb0 <- 10\nb1 <- 5\ndat <- sim_design(n, nx = list(x = runif(n)))\ndat$lp <- with(dat, exp(log(b0) + log(b1)*x))\ndat$y <- with(dat, MASS::rnegbin(n, lp, theta))\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"rhoqkiyghr\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#rhoqkiyghr table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#rhoqkiyghr thead, #rhoqkiyghr tbody, #rhoqkiyghr tfoot, #rhoqkiyghr tr, #rhoqkiyghr td, #rhoqkiyghr th {\n  border-style: none;\n}\n\n#rhoqkiyghr p {\n  margin: 0;\n  padding: 0;\n}\n\n#rhoqkiyghr .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#rhoqkiyghr .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#rhoqkiyghr .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#rhoqkiyghr .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#rhoqkiyghr .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#rhoqkiyghr .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#rhoqkiyghr .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#rhoqkiyghr .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#rhoqkiyghr .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#rhoqkiyghr .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#rhoqkiyghr .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#rhoqkiyghr .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#rhoqkiyghr .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#rhoqkiyghr .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#rhoqkiyghr .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rhoqkiyghr .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#rhoqkiyghr .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#rhoqkiyghr .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#rhoqkiyghr .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rhoqkiyghr .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#rhoqkiyghr .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rhoqkiyghr .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#rhoqkiyghr .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rhoqkiyghr .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#rhoqkiyghr .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#rhoqkiyghr .gt_left {\n  text-align: left;\n}\n\n#rhoqkiyghr .gt_center {\n  text-align: center;\n}\n\n#rhoqkiyghr .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#rhoqkiyghr .gt_font_normal {\n  font-weight: normal;\n}\n\n#rhoqkiyghr .gt_font_bold {\n  font-weight: bold;\n}\n\n#rhoqkiyghr .gt_font_italic {\n  font-style: italic;\n}\n\n#rhoqkiyghr .gt_super {\n  font-size: 65%;\n}\n\n#rhoqkiyghr .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#rhoqkiyghr .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#rhoqkiyghr .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#rhoqkiyghr .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#rhoqkiyghr .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#rhoqkiyghr .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#rhoqkiyghr .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"id\">id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"x\">x</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold;\" scope=\"col\" id=\"y\">y</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">1</td>\n<td headers=\"x\" class=\"gt_row gt_center\">0.427</td>\n<td headers=\"y\" class=\"gt_row gt_center\">11</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">2</td>\n<td headers=\"x\" class=\"gt_row gt_center\">0.365</td>\n<td headers=\"y\" class=\"gt_row gt_center\">13</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">...</td>\n<td headers=\"x\" class=\"gt_row gt_center\">...</td>\n<td headers=\"y\" class=\"gt_row gt_center\">...</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">99</td>\n<td headers=\"x\" class=\"gt_row gt_center\">0.966</td>\n<td headers=\"y\" class=\"gt_row gt_center\">41</td></tr>\n    <tr><td headers=\"id\" class=\"gt_row gt_center\">100</td>\n<td headers=\"x\" class=\"gt_row gt_center\">0.154</td>\n<td headers=\"y\" class=\"gt_row gt_center\">12</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n## Negative-binomial model\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-42-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Negative-binomial model\n\nThen we can fit the model:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit_nb <- MASS::glm.nb(y ~ x, data = dat)\nsummary(fit_nb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> MASS::glm.nb(formula = y ~ x, data = dat, init.theta = 11.32327809, \n#>     link = log)\n#> \n#> Coefficients:\n#>             Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)  2.17693    0.08282   26.28   <2e-16 ***\n#> x            1.82119    0.13811   13.19   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for Negative Binomial(11.3233) family taken to be 1)\n#> \n#>     Null deviance: 273.823  on 99  degrees of freedom\n#> Residual deviance:  98.035  on 98  degrees of freedom\n#> AIC: 696.14\n#> \n#> Number of Fisher Scoring iterations: 1\n#> \n#> \n#>               Theta:  11.32 \n#>           Std. Err.:  2.38 \n#> \n#>  2 x log-likelihood:  -690.143\n```\n\n\n:::\n:::\n\n\n\n## Negative-binomial model\n\nHere we compare the expected variance ($\\pm 2\\sqrt{V(y_i)}$) of the Negative binomial and Poisson models:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-44-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Negative-binomial model\n\nHere we compare the expected variance ($\\pm 2\\sqrt{V(y_i)}$) of the three models:\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-45-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Negative-binomial model\n\nWe can compare the coefficients fitting the Poisson, the Quasi-Poisson and the Negative-binomial model:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit_p <- glm(y ~ x, data = dat, family = poisson(link = \"log\"))\nfit_qp <- glm(y ~ x, data = dat, family = quasipoisson(link = \"log\"))\ncar::compareCoefs(fit_nb, fit_p, fit_qp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Calls:\n#> 1: MASS::glm.nb(formula = y ~ x, data = dat, init.theta = 11.32327809, link \n#>   = log)\n#> 2: glm(formula = y ~ x, family = poisson(link = \"log\"), data = dat)\n#> 3: glm(formula = y ~ x, family = quasipoisson(link = \"log\"), data = dat)\n#> \n#>             Model 1 Model 2 Model 3\n#> (Intercept)  2.1769  2.2043  2.2043\n#> SE           0.0828  0.0534  0.0970\n#>                                    \n#> x            1.8212  1.7723  1.7723\n#> SE           0.1381  0.0802  0.1456\n#> \n```\n\n\n:::\n:::\n\n\n\n## Negative-binomial model (NB) vs Quasi-poisson (QP)\n\n- The NB has the likelihood function thus AIC, LRT and other likelihood-based metrics works compared to the QP\n- The NB assume a different mean-variance relationship thus estimated coefficients could be different to the P where QP produce the same estimates.\n- Both NB and QP estimate higher standard errors in the presence of overdispersion\n- If there is evidence of overdispersion, the important is to fit a model that take into account it\n\n## Multilevel Poisson\n\n- Even if we did not discussed multilevel models, the negative binomial model implicitly introduced the topic.\n- Putting a Gamma distribution on the $\\lambda$ parameter allows to introduce more variability than assuming a fixed $\\lambda$.\n- A similar result can be achieved assuming that each observation has a different $\\lambda$ i.e. adding a random-effect\n\n## Multilevel Poisson\n\n\n\n\n\n\n\nIn fact, if we think about number of errors (or whatever variable) for each participant, we are implicitly saying that each participant perform multiple \"trials\".\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nhead(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # A tibble: 6 × 6\n#>      id class    studyh class_c    lp solved\n#>   <int> <fct>     <dbl>   <dbl> <dbl>  <int>\n#> 1     1 online       82       0  22.6     24\n#> 2     2 inperson     65       1  47.7     50\n#> 3     3 online       12       0  11.3     15\n#> 4     4 inperson     54       1  42.8     50\n#> 5     5 online       18       0  12.0     10\n#> 6     6 inperson     64       1  47.3     41\n```\n\n\n:::\n:::\n\n\n\nEach `id` performs multiple problems solving a certain number of them (`solved`). There is an hidden multilevel structure here.\n\n## Multilevel Poisson\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(lme4)\nfit_m <- glmer(solved ~ studyh + (1|id), data = dat, family = poisson())\nsummary(fit_m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Generalized linear mixed model fit by maximum likelihood (Laplace\n#>   Approximation) [glmerMod]\n#>  Family: poisson  ( log )\n#> Formula: solved ~ studyh + (1 | id)\n#>    Data: dat\n#> \n#>      AIC      BIC   logLik deviance df.resid \n#>    322.8    327.8   -158.4    316.8       37 \n#> \n#> Scaled residuals: \n#>      Min       1Q   Median       3Q      Max \n#> -0.92459 -0.44737  0.02909  0.28948  0.56780 \n#> \n#> Random effects:\n#>  Groups Name        Variance Std.Dev.\n#>  id     (Intercept) 0.1946   0.4411  \n#> Number of obs: 40, groups:  id, 40\n#> \n#> Fixed effects:\n#>             Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) 2.609225   0.156018  16.724  < 2e-16 ***\n#> studyh      0.013478   0.002701   4.991 6.01e-07 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Correlation of Fixed Effects:\n#>        (Intr)\n#> studyh -0.869\n#> optimizer (Nelder_Mead) convergence code: 0 (OK)\n#> Model is nearly unidentifiable: very large eigenvalue\n#>  - Rescale variables?\n```\n\n\n:::\n:::\n\n\n\n## Multilevel Poisson\n\nLet's see the overdispersion compared to the non-multilevel poisson and the negative-binomial model:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit_p <- glm(solved ~ studyh, data = dat, family = poisson(link = \"log\"))\nfit_nb <- MASS::glm.nb(solved ~ studyh, data = dat)\n\nperformance::check_overdispersion(fit_p)\n#> # Overdispersion test\n#> \n#>        dispersion ratio =   6.115\n#>   Pearson's Chi-Squared = 232.369\n#>                 p-value = < 0.001\nperformance::check_overdispersion(fit_nb)\n#> # Overdispersion test\n#> \n#>  dispersion ratio = 0.878\n#>           p-value = 0.856\nperformance::check_overdispersion(fit_m)\n#> # Overdispersion test\n#> \n#>        dispersion ratio = 0.195\n#>   Pearson's Chi-Squared = 7.228\n#>                 p-value =     1\n```\n:::\n\n\n\n\n## Simulate NB data `#extra`^[Using `vmr = 1` it will use the `rpois()` function]\n\nIf you want to try to simulate NB data you can use the `MASS::rnegbin(n, mu, theta)` function or the `rnb(n, mu, vmr)` custom function that could be more intuitive because requires $\\mu$ (i.e., the mean) and `vmr` that is the desired variance-mean ratio. Using `message = TRUE` it will tells the $\\theta$ value:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ny <- rnb(1e5, mu = 10, vmr = 7, message = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n#> y ~ NegBin(mu = 10, theta = 1.67), var = 70.00, vmr = 7.00\n```\n\n\n:::\n\n```{.r .cell-code}\nnprint(mu = mean(y), v = var(y), vmr = var(y) / mean(y))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>     mu      v    vmr \n#>  9.958 69.569  6.986\n```\n\n\n:::\n:::\n\n\n\n## Simulate NB data `#extra`\n\nYou can also use the `theta` parameter within the `rnb` function. As $\\theta$ increase the overdispersion is reduced. Thus you can think the inverse of $1/\\theta$ as an index of overdispersion.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ny <- rnb(1e5, mu = 10, theta = 10, message = TRUE)\ny <- rnb(1e5, mu = 10, theta = 5, message = TRUE)\ny <- rnb(1e5, mu = 10, theta = 1, message = TRUE)\n```\n:::\n\n\n\n## Deviance based pseudo-$R^2$\n\nThe Deviance based pseudo-$R^2$ is computed from the ratio between the residual deviance and the null deviance^[https://en.wikipedia.org/wiki/Pseudo-R-squared]:\n\n$$\nR^2 = 1 - \\frac{D_{current}}{D_{null}}\n$$\n<!-- ref(\"Applied Regression Analysis and Generalized Linear Models, Fox (2016)\", \"14.1\", \"383\") -->\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n1 - fit_p$deviance/fit_p$null.deviance\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] 0.4162731\n```\n\n\n:::\n:::\n\n\n\n\n## McFadden's pseudo-$R^2$\n\nThe McFadden's pseudo-$R^2$ compute the ratio between the log-likelihood of the intercept-only (i.e., null) model and the current model [@McFadden1987-qq]:\n\n$$\nR^2 = 1 - \\frac{\\log(\\mathcal{L_{current}})}{\\log(\\mathcal{L_{null}})}\n$$\n\nThere is also the adjusted version that take into account the number of parameters of the model. In R can be computed manually or using the `performance::r2_mcfadden()`:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nperformance::r2_mcfadden(fit_p)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> # R2 for Generalized Linear Regression\n#>        R2: 0.280\n#>   adj. R2: 0.277\n```\n\n\n:::\n:::\n\n\n\n## Nagelkerke's pseudo-$R^2$\n\nThe Cox and Snell's [@Cox1989-ql] $R^2$ is defined as:\n\n$$\nR^2 = 1 - \\left(\\frac{\\mathcal{L_{null}}}{\\mathcal{L_{current}}}\\right)^{\\frac{2}{n}}\n$$\n\nWhere Nagelkerke [@Nagelkerke1991-gr] provide a correction to set the range of values between 0 and 1.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nperformance::r2_nagelkerke(fit_p)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Nagelkerke's R2 \n#>       0.9871216\n```\n\n\n:::\n:::\n\n\n\n# Extra {.section}\n\n## Interaction, Poisson vs Linear^[Thank to Enrico Toffalini for this great example]\n\nLet's simulate a GLM where there is a main effect but no interaction:\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ndat <- sim_design(200, nx = list(x = rnorm(200)), cx = list(g = c(\"a\", \"b\")))\ndat <- sim_data(dat, exp(log(10) + log(1.5) * x + log(2) * g_c + 0 * g_c * x), model = \"poisson\")\ndat |> \n  ggplot(aes(x = x, y = y, color = g)) +\n  geom_point() +\n  stat_smooth(method = \"glm\",\n              method.args = list(family = poisson()))\n```\n\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-56-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Interaction, Poisson vs Linear\n\nLet's fit a linear model and the Poisson GLM with the interaction term:\n\n::: {.panel-tabset}\n\n### Gaussian GLM\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit_lm <- lm(y ~ x * g, data = dat)\nsummary(fit_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> lm(formula = y ~ x * g, data = dat)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -10.9594  -2.7974  -0.3394   2.4466  14.8487 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  11.0610     0.2941  37.603   <2e-16 ***\n#> x             3.9829     0.2979  13.371   <2e-16 ***\n#> g2            9.9577     0.4163  23.921   <2e-16 ***\n#> x:g2          4.0287     0.4347   9.269   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 4.116 on 396 degrees of freedom\n#> Multiple R-squared:  0.7717,\tAdjusted R-squared:   0.77 \n#> F-statistic: 446.3 on 3 and 396 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n\n\n\n### Poisson GLM\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfit_glm <- glm(y ~ x * g, data = dat, family = poisson(link = \"log\"))\nsummary(fit_glm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> Call:\n#> glm(formula = y ~ x * g, family = poisson(link = \"log\"), data = dat)\n#> \n#> Coefficients:\n#>             Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)  2.33573    0.02238 104.350   <2e-16 ***\n#> x            0.38286    0.02254  16.986   <2e-16 ***\n#> g2           0.64219    0.02765  23.226   <2e-16 ***\n#> x:g2         0.02549    0.02850   0.894    0.371    \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for poisson family taken to be 1)\n#> \n#>     Null deviance: 1816.48  on 399  degrees of freedom\n#> Residual deviance:  385.92  on 396  degrees of freedom\n#> AIC: 2157.8\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n\n\n:::\n:::\n\n\n\n:::\n\n## Interaction, Poisson vs Linear\n\nThe linear model is estimating a completely misleading interaction due to the mean-variance relationship of the Poisson distribution.\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-59-1.svg){fig-align='center' width=576}\n:::\n:::\n\n\n\n## Interaction, Poisson vs Linear\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](03-poisson-glm_files/figure-revealjs/unnamed-chunk-60-1.svg){fig-align='center' width=960}\n:::\n:::\n\n\n\n## For a more extensive example...\n\nIn this presentation we showed how serious could be the situation when fitting the wrong distribution and link function and estimating an interaction term.\n\n[https://filippogambarota.github.io/files/slides/2024-aip-sviluppo.pdf](https://filippogambarota.github.io/files/slides/2024-aip-sviluppo.pdf)\n\n## References\n\n\n",
    "supporting": [
      "03-poisson-glm_files/figure-revealjs"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}